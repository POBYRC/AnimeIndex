<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anime Manager Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --bg-soft: #121a31;
      --card: #131d3a;
      --card-2: #101935;
      --text: #eaf0ff;
      --muted: #9aa7cb;
      --primary: #7c9cff;
      --primary-2: #56d3ff;
      --danger: #ff6f91;
      --ok: #36d399;
      --border: rgba(255,255,255,.08);
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; }
    body {
      font-family: 'Prompt', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 15% -20%, rgba(124,156,255,.25), transparent 60%),
        radial-gradient(800px 400px at 90% -10%, rgba(86,211,255,.18), transparent 60%),
        linear-gradient(180deg, #0b1020, #080d1b);
      padding: 24px;
    }

    .shell {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      gap: 18px;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(124,156,255,.16), rgba(86,211,255,.08));
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .title-wrap h1 { margin: 0; font-size: clamp(22px, 3vw, 30px); }
    .title-wrap p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }

    .stats { display: flex; flex-wrap: wrap; gap: 10px; }
    .chip {
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .chip strong { color: var(--text); margin-left: 6px; }

    .layout {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 18px;
      min-height: 70vh;
    }

    .panel {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card), var(--card-2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .panel-head {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: grid;
      gap: 10px;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 10px;
      align-items: center;
    }

    .input, .select, .btn, textarea {
      font: inherit;
      color: var(--text);
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      outline: none;
      transition: .18s ease;
      width: 100%;
    }

    .input:focus, .select:focus, textarea:focus {
      border-color: rgba(124,156,255,.75);
      box-shadow: 0 0 0 3px rgba(124,156,255,.2);
    }

    .btn {
      width: auto;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 600;
    }

    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(90deg, var(--primary), var(--primary-2)); color: #08122e; border: none; }
    .btn.danger { background: rgba(255,111,145,.12); border-color: rgba(255,111,145,.4); color: #ffc2d1; }
    .btn.ghost { background: transparent; }

    .list {
      padding: 14px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      align-content: start;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255,255,255,.03);
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .thumb {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      background: #1c284f;
    }

    .card-body { padding: 10px; display: grid; gap: 8px; }
    .card-title { margin: 0; font-size: 14px; line-height: 1.35; }
    .card-link { color: var(--muted); font-size: 12px; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .tags { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 11px; border-radius: 999px; padding: 3px 8px; background: rgba(124,156,255,.16); color: #dfe8ff; }

    .card-actions { margin-top: 2px; display: flex; gap: 6px; }
    .mini { flex: 1; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; padding: 7px; }
    .mini.del { color: #ffc2d1; border-color: rgba(255,111,145,.45); }

    .aside { display: grid; gap: 12px; align-content: start; }
    .section { padding: 14px; border-bottom: 1px solid var(--border); }
    .section:last-child { border-bottom: none; }
    .section h3 { margin: 0 0 10px; font-size: 16px; }
    .section p { margin: 0 0 10px; color: var(--muted); font-size: 13px; }

    .field { display: grid; gap: 6px; margin-bottom: 10px; }
    .field label { color: var(--muted); font-size: 13px; }

    .category-box {
      max-height: 150px;
      overflow: auto;
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 8px;
      display: grid;
      gap: 6px;
      grid-template-columns: repeat(auto-fill, minmax(130px,1fr));
    }

    .category-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #dce6ff; }

    .json-view {
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 260px;
      overflow: auto;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      border-radius: 12px;
      padding: 10px;
      font-size: 12px;
      color: #d9e4ff;
    }

    .muted { color: var(--muted); font-size: 13px; }
    .empty { padding: 26px; text-align: center; color: var(--muted); border: 1px dashed var(--border); border-radius: 12px; grid-column: 1 / -1; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2,6,18,.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 30;
    }

    .modal {
      width: min(760px, 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, #132040, #101a33);
      box-shadow: var(--shadow);
      max-height: 88vh;
      overflow: auto;
      padding: 16px;
      display: grid;
      gap: 10px;
    }

    .modal-grid { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .modal-grid .full { grid-column: 1/-1; }

    @media (max-width: 1080px) {
      .layout { grid-template-columns: 1fr; }
      .toolbar { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 680px) {
      body { padding: 12px; }
      .toolbar { grid-template-columns: 1fr; }
      .modal-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="title-wrap">
        <h1>Anime Manager Studio</h1>
        <p>จัดการรายการอนิเมะ: เพิ่ม / แก้ไข / ลบ / ดาวน์โหลด JSON ได้จากหน้านี้</p>
      </div>
      <div class="stats">
        <div class="chip">แหล่งข้อมูล <strong id="sourceLabel">anime_data.json</strong></div>
        <div class="chip">ทั้งหมด <strong id="totalCount">0</strong></div>
        <div class="chip">หมวดหมู่ <strong id="categoryCount">0</strong></div>
      </div>
    </header>

    <div class="layout">
      <section class="panel">
        <div class="panel-head">
          <div class="toolbar">
            <input id="quickSearch" class="input" placeholder="ค้นหาชื่อเรื่องหรือหมวดหมู่..." />
            <button id="switchSourceBtn" class="btn">สลับไป H.json</button>
            <button id="downloadBtn" class="btn">ดาวน์โหลด JSON</button>
            <button id="copyBtn" class="btn ghost">คัดลอก JSON</button>
          </div>
          <div class="muted" id="statusText">กำลังโหลดข้อมูล...</div>
        </div>
        <div id="grid" class="list"></div>
      </section>

      <aside class="panel aside">
        <div class="section">
          <h3>เพิ่มอนิเมะใหม่</h3>
          <p>เพิ่มรายการใหม่ได้ทันที แล้วกดดาวน์โหลดไฟล์ JSON เพื่ออัปเดตข้อมูล</p>

          <div class="field">
            <label for="addTitle">ชื่อเรื่อง</label>
            <input id="addTitle" class="input" placeholder="เช่น Kimetsu no Yaiba" />
          </div>

          <div class="field">
            <label for="addLink">ลิงก์ Anime</label>
            <input id="addLink" class="input" placeholder="https://..." />
          </div>

          <div class="field">
            <label for="addImage">ลิงก์รูปภาพ</label>
            <input id="addImage" class="input" placeholder="https://...jpg" />
          </div>

          <div class="field">
            <label for="insertMode">ตำแหน่งการเพิ่ม</label>
            <select id="insertMode" class="select">
              <option value="last">ต่อท้ายรายการ (ล่าสุด)</option>
              <option value="after">แทรกต่อจากเรื่องที่เลือก</option>
            </select>
          </div>

          <div class="field" id="insertAfterWrap" style="display:none;">
            <label for="insertAfterId">เลือกเรื่องที่จะแทรกต่อจาก</label>
            <select id="insertAfterId" class="select"></select>
          </div>

          <div class="field">
            <label>หมวดหมู่ (เลือกได้หลายอัน)</label>
            <div id="addCategoryBox" class="category-box"></div>
          </div>

          <div class="field">
            <label for="addCategoryCustom">เพิ่มหมวดหมู่ใหม่ (คั่นด้วย ,)</label>
            <input id="addCategoryCustom" class="input" placeholder="Action, Comedy" />
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="addBtn" class="btn primary">เพิ่มเรื่อง</button>
            <button id="clearNew" class="btn ghost">รีเซ็ตฟอร์ม</button>
          </div>
        </div>

        <div class="section">
          <h3>JSON Preview</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
            <button id="toggleJsonBtn" class="btn ghost">ซ่อน JSON</button>
            <button id="downloadJson" class="btn">ดาวน์โหลดไฟล์ .json</button>
            <button id="copyJsonBtn" class="btn ghost">คัดลอก</button>
            <button id="clearAllBtn" class="btn danger">ลบทั้งหมด</button>
          </div>
          <pre id="jsonView" class="json-view">กำลังโหลดข้อมูล...</pre>
        </div>
      </aside>
    </div>
  </div>

  <div id="editModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <strong id="editModalTitle">แก้ไขรายการอนิเมะ</strong>
        <button id="editCloseBtn" class="btn">✕</button>
      </div>

      <div class="modal-grid">
        <div class="field full">
          <label for="editTitle">ชื่อเรื่อง</label>
          <input id="editTitle" class="input" />
        </div>
        <div class="field full">
          <label for="editLink">ลิงก์ Anime</label>
          <input id="editLink" class="input" />
        </div>
        <div class="field full">
          <label for="editImage">ลิงก์รูปภาพ</label>
          <input id="editImage" class="input" />
        </div>
        <div class="field full">
          <label>หมวดหมู่</label>
          <div id="editCategoryBox" class="category-box"></div>
        </div>
        <div class="field full">
          <label for="editCategoryCustom">เพิ่มหมวดหมู่ใหม่ (คั่นด้วย ,)</label>
          <input id="editCategoryCustom" class="input" placeholder="Adventure, Romance" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="saveEdit" class="btn primary">บันทึก</button>
        <button id="cancelEdit" class="btn ghost">ยกเลิก</button>
      </div>
    </div>
  </div>

  <script>
    let currentSource = 'anime_data.json';
    let allAnimes = [];
    let allCategories = [];
    let editingId = null;
    let jsonVisible = true;

    const el = {
      grid: document.getElementById('grid'),
      sourceLabel: document.getElementById('sourceLabel'),
      totalCount: document.getElementById('totalCount'),
      categoryCount: document.getElementById('categoryCount'),
      statusText: document.getElementById('statusText'),
      quickSearch: document.getElementById('quickSearch'),
      switchSourceBtn: document.getElementById('switchSourceBtn'),
      downloadBtn: document.getElementById('downloadBtn'),
      copyBtn: document.getElementById('copyBtn'),
      jsonView: document.getElementById('jsonView'),
      toggleJsonBtn: document.getElementById('toggleJsonBtn'),
      downloadJson: document.getElementById('downloadJson'),
      copyJsonBtn: document.getElementById('copyJsonBtn'),
      clearAllBtn: document.getElementById('clearAllBtn'),
      addTitle: document.getElementById('addTitle'),
      addLink: document.getElementById('addLink'),
      addImage: document.getElementById('addImage'),
      addCategoryBox: document.getElementById('addCategoryBox'),
      addCategoryCustom: document.getElementById('addCategoryCustom'),
      addBtn: document.getElementById('addBtn'),
      clearNew: document.getElementById('clearNew'),
      insertMode: document.getElementById('insertMode'),
      insertAfterWrap: document.getElementById('insertAfterWrap'),
      insertAfterId: document.getElementById('insertAfterId'),
      editModalBackdrop: document.getElementById('editModalBackdrop'),
      editCloseBtn: document.getElementById('editCloseBtn'),
      cancelEdit: document.getElementById('cancelEdit'),
      saveEdit: document.getElementById('saveEdit'),
      editTitle: document.getElementById('editTitle'),
      editLink: document.getElementById('editLink'),
      editImage: document.getElementById('editImage'),
      editCategoryBox: document.getElementById('editCategoryBox'),
      editCategoryCustom: document.getElementById('editCategoryCustom')
    };

    function escapeHtml(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function placeholderImage(title = 'Anime') {
      const text = encodeURIComponent(String(title).slice(0, 24));
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='900'>
        <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#1e2d5c'/><stop offset='1' stop-color='#233f7a'/></linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Prompt, sans-serif' font-size='40' fill='#dce7ff'>${text}</text>
      </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function parseCustomCategories(raw) {
      return String(raw || '')
        .split(',')
        .map(c => c.trim())
        .filter(Boolean);
    }

    function mergeCategories(base, extra) {
      const set = new Set([...(base || []), ...(extra || [])]);
      return [...set].sort((a, b) => a.localeCompare(b, 'th'));
    }

    function collectCategoriesFromData() {
      const set = new Set();
      allAnimes.forEach(item => (item.category || []).forEach(c => set.add(c)));
      allCategories = [...set].sort((a, b) => a.localeCompare(b, 'th'));
    }

    function buildCategoryCheckboxes(container, selected = []) {
      container.innerHTML = '';
      if (!allCategories.length) {
        container.innerHTML = '<div class="muted">ยังไม่มีหมวดหมู่</div>';
        return;
      }

      allCategories.forEach(cat => {
        const id = `${container.id}-${cat.replace(/\s+/g, '_')}`;
        const row = document.createElement('label');
        row.className = 'category-item';
        row.innerHTML = `<input type="checkbox" id="${escapeHtml(id)}" value="${escapeHtml(cat)}"> <span>${escapeHtml(cat)}</span>`;
        const input = row.querySelector('input');
        input.checked = selected.includes(cat);
        container.appendChild(row);
      });
    }

    function getCheckedCategories(container) {
      return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
    }

    function refreshStats() {
      el.sourceLabel.textContent = currentSource;
      el.totalCount.textContent = String(allAnimes.length);
      el.categoryCount.textContent = String(allCategories.length);
    }

    function renderInsertAfterOptions() {
      el.insertAfterId.innerHTML = '';
      allAnimes.forEach(item => {
        const option = document.createElement('option');
        option.value = String(item.id);
        option.textContent = `${item.id}. ${item.title || '(ไม่มีชื่อ)'}`;
        el.insertAfterId.appendChild(option);
      });
    }

    function normalizeIds() {
      allAnimes.forEach((item, idx) => {
        item.id = idx + 1;
      });
    }

    function getFilteredList() {
      const q = el.quickSearch.value.trim().toLowerCase();
      if (!q) return allAnimes;
      return allAnimes.filter(item => {
        const inTitle = (item.title || '').toLowerCase().includes(q);
        const inCategory = (item.category || []).some(c => c.toLowerCase().includes(q));
        return inTitle || inCategory;
      });
    }

    function renderList() {
      const list = getFilteredList();
      el.grid.innerHTML = '';

      if (!list.length) {
        el.grid.innerHTML = '<div class="empty">ไม่พบรายการที่ตรงกับเงื่อนไข</div>';
        return;
      }

      list.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        const tags = (item.category || []).slice(0, 8).map(cat => `<span class="tag">${escapeHtml(cat)}</span>`).join('');

        card.innerHTML = `
          <img class="thumb" src="${escapeHtml(item.image || placeholderImage(item.title))}" alt="${escapeHtml(item.title || '')}" />
          <div class="card-body">
            <h4 class="card-title">${escapeHtml(item.title || '(ไม่มีชื่อ)')}</h4>
            <a class="card-link" href="${escapeHtml(item.link || '#')}" target="_blank" rel="noopener">${escapeHtml(item.link || 'ไม่มีลิงก์')}</a>
            <div class="tags">${tags || '<span class="tag">ไม่มีหมวดหมู่</span>'}</div>
            <div class="card-actions">
              <button class="mini" data-action="edit" data-id="${item.id}">แก้ไข</button>
              <button class="mini del" data-action="delete" data-id="${item.id}">ลบ</button>
            </div>
          </div>
        `;

        const img = card.querySelector('img');
        img.onerror = () => { img.src = placeholderImage(item.title); };

        el.grid.appendChild(card);
      });
    }

    function updateJsonView() {
      el.jsonView.textContent = JSON.stringify(allAnimes, null, 2);
    }

    function syncUI() {
      collectCategoriesFromData();
      buildCategoryCheckboxes(el.addCategoryBox);
      renderInsertAfterOptions();
      refreshStats();
      renderList();
      updateJsonView();
    }

    async function loadJSON() {
      el.statusText.textContent = 'กำลังโหลดข้อมูล...';
      try {
        const res = await fetch(currentSource, { cache: 'no-store' });
        if (!res.ok) throw new Error(`โหลดไฟล์ไม่สำเร็จ (${res.status})`);
        const data = await res.json();
        allAnimes = Array.isArray(data) ? data : [];
        normalizeIds();
        syncUI();
        el.statusText.textContent = `โหลดข้อมูลสำเร็จ ${allAnimes.length} รายการ`;
      } catch (error) {
        allAnimes = [];
        syncUI();
        el.statusText.textContent = 'โหลดข้อมูลไม่สำเร็จ โปรดตรวจสอบ path ของไฟล์ JSON';
        console.error(error);
      }
    }

    function downloadJSON(filename = 'anime_data.json') {
      const blob = new Blob([JSON.stringify(allAnimes, null, 2)], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function copyJSON() {
      try {
        await navigator.clipboard.writeText(JSON.stringify(allAnimes, null, 2));
        alert('คัดลอก JSON เรียบร้อยแล้ว');
      } catch (error) {
        alert('คัดลอกไม่สำเร็จ: ' + error.message);
      }
    }

    function resetAddForm() {
      el.addTitle.value = '';
      el.addLink.value = '';
      el.addImage.value = '';
      el.addCategoryCustom.value = '';
      buildCategoryCheckboxes(el.addCategoryBox);
      el.insertMode.value = 'last';
      el.insertAfterWrap.style.display = 'none';
    }

    function addAnime() {
      const title = el.addTitle.value.trim();
      const link = el.addLink.value.trim();
      const image = el.addImage.value.trim();

      if (!title) {
        alert('กรุณากรอกชื่อเรื่อง');
        return;
      }

      const selectedCategories = getCheckedCategories(el.addCategoryBox);
      const customCategories = parseCustomCategories(el.addCategoryCustom.value);
      const category = mergeCategories(selectedCategories, customCategories);

      const newItem = {
        id: 0,
        title,
        link,
        image: image || undefined,
        category
      };

      if (el.insertMode.value === 'after' && allAnimes.length) {
        const afterId = Number(el.insertAfterId.value);
        const idx = allAnimes.findIndex(a => a.id === afterId);
        if (idx >= 0) {
          allAnimes.splice(idx + 1, 0, newItem);
        } else {
          allAnimes.push(newItem);
        }
      } else {
        allAnimes.push(newItem);
      }

      normalizeIds();
      syncUI();
      resetAddForm();
      el.statusText.textContent = 'เพิ่มรายการใหม่เรียบร้อย';
    }

    function openEditModal(id) {
      const item = allAnimes.find(a => a.id === id);
      if (!item) return;
      editingId = id;

      el.editTitle.value = item.title || '';
      el.editLink.value = item.link || '';
      el.editImage.value = item.image || '';
      el.editCategoryCustom.value = '';
      buildCategoryCheckboxes(el.editCategoryBox, item.category || []);

      el.editModalBackdrop.style.display = 'flex';
      el.editModalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closeEditModal() {
      editingId = null;
      el.editModalBackdrop.style.display = 'none';
      el.editModalBackdrop.setAttribute('aria-hidden', 'true');
    }

    function saveEdit() {
      if (editingId == null) return;

      const idx = allAnimes.findIndex(a => a.id === editingId);
      if (idx < 0) return;

      const title = el.editTitle.value.trim();
      if (!title) {
        alert('กรุณากรอกชื่อเรื่อง');
        return;
      }

      const selectedCategories = getCheckedCategories(el.editCategoryBox);
      const customCategories = parseCustomCategories(el.editCategoryCustom.value);

      allAnimes[idx].title = title;
      allAnimes[idx].link = el.editLink.value.trim();
      allAnimes[idx].image = el.editImage.value.trim() || undefined;
      allAnimes[idx].category = mergeCategories(selectedCategories, customCategories);

      normalizeIds();
      syncUI();
      closeEditModal();
      el.statusText.textContent = 'บันทึกการแก้ไขเรียบร้อย';
    }

    function deleteAnime(id) {
      if (!confirm('ต้องการลบรายการนี้จริงหรือไม่?')) return;
      allAnimes = allAnimes.filter(a => a.id !== id);
      normalizeIds();
      syncUI();
      el.statusText.textContent = 'ลบรายการเรียบร้อย';
    }

    function clearAll() {
      if (!confirm('ต้องการลบรายการทั้งหมดจริงหรือไม่?')) return;
      allAnimes = [];
      syncUI();
      el.statusText.textContent = 'ลบข้อมูลทั้งหมดแล้ว';
    }

    // Events
    el.quickSearch.addEventListener('input', renderList);
    el.addBtn.addEventListener('click', addAnime);
    el.clearNew.addEventListener('click', resetAddForm);
    el.downloadBtn.addEventListener('click', () => downloadJSON(currentSource === 'H.json' ? 'H.json' : 'anime_data.json'));
    el.downloadJson.addEventListener('click', () => downloadJSON(currentSource === 'H.json' ? 'H.json' : 'anime_data.json'));
    el.copyBtn.addEventListener('click', copyJSON);
    el.copyJsonBtn.addEventListener('click', copyJSON);
    el.clearAllBtn.addEventListener('click', clearAll);

    el.toggleJsonBtn.addEventListener('click', () => {
      jsonVisible = !jsonVisible;
      el.jsonView.style.display = jsonVisible ? 'block' : 'none';
      el.toggleJsonBtn.textContent = jsonVisible ? 'ซ่อน JSON' : 'แสดง JSON';
    });

    el.insertMode.addEventListener('change', () => {
      el.insertAfterWrap.style.display = el.insertMode.value === 'after' ? 'block' : 'none';
    });

    el.switchSourceBtn.addEventListener('click', async () => {
      currentSource = currentSource === 'anime_data.json' ? 'H.json' : 'anime_data.json';
      el.switchSourceBtn.textContent = currentSource === 'anime_data.json' ? 'สลับไป H.json' : 'สลับไป anime_data.json';
      await loadJSON();
    });

    el.grid.addEventListener('click', event => {
      const target = event.target.closest('[data-action]');
      if (!target) return;
      const id = Number(target.dataset.id);
      if (target.dataset.action === 'edit') openEditModal(id);
      if (target.dataset.action === 'delete') deleteAnime(id);
    });

    el.editCloseBtn.addEventListener('click', closeEditModal);
    el.cancelEdit.addEventListener('click', closeEditModal);
    el.saveEdit.addEventListener('click', saveEdit);
    el.editModalBackdrop.addEventListener('click', event => {
      if (event.target === el.editModalBackdrop) closeEditModal();
    });

    // init
    loadJSON();
  </script>
</body>
</html>
